# This can be used for deploying the application locally and not through CI. 
# Can be useful e.g. when first setting up infra and you need an image in ECR to set up the rest of the infra.

#!/usr/bin/env just --justfile
export PATH := "./node_modules/.bin:" + env_var('PATH')
PROJECT_NAME := "kvittering-backend"

# To run with email, see src/core/get_and_validate_env.py for the correct env vars to set
run:
  docker build -t {{PROJECT_NAME}}:latest -f Dockerfile ../.. && \
  docker run \
    -p 5000:5000 \
    -e ENVIRONMENT=dev \
    -e STORAGE_BUCKET=kvittering-archive.online.ntnu.no \
    -e EMAIL_ENABLED=false \
    {{PROJECT_NAME}}:latest

# For building/deploying to aws environments:
build env:
  docker build --platform linux/amd64 -t {{PROJECT_NAME}}:latest -f Dockerfile ../..

push env:
  docker tag {{PROJECT_NAME}}:latest 891459268445.dkr.ecr.eu-north-1.amazonaws.com/monoweb/{{env}}/{{PROJECT_NAME}}:latest
  docker push 891459268445.dkr.ecr.eu-north-1.amazonaws.com/monoweb/{{env}}/{{PROJECT_NAME}}:latest

release env: (build env) (push env)
