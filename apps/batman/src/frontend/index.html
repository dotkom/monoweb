<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <style>
    table,
    th,
    td {
      border: 1px solid black;
      border-collapse: collapse;
    }
    th,
    td {
      padding: 10px;
      text-align: left;
    }
  </style>
  <body>
    <audio id="audioPlayer">
      <source src="success.mp3" type="audio/mp3" />
      Your browser does not support the audio element.
    </audio>
    <button onclick="enableAudio()" id="enableAudioBtn">Skru på lyd</button>
    <!-- transactionstable -->
    <h2>Siste 10 transaksjoner</h2>
    <table id="transactionsTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Name</th>
          <th>Beskrivelse</th>
        </tr>
      </thead>

      <tbody></tbody>
    </table>

    <script>
      function formatDatetime(datetime, now) {
        // Ensure datetime and now are treated as Date objects
        const datetimeObj = new Date(datetime);
        const nowObj = new Date(now);

        // Calculate the start of today and yesterday in the local timezone
        const startOfToday = new Date(nowObj.setHours(0, 0, 0, 0));
        const startOfYesterday = new Date(
          startOfToday.getTime() - 24 * 60 * 60 * 1000
        );

        // Compare datetimeObj against startOfToday and startOfYesterday
        if (datetimeObj >= startOfYesterday && datetimeObj < startOfToday) {
          // Formatting for "yesterday"
          const timeString = datetimeObj.toLocaleTimeString("nb-NO", {
            hour: "2-digit",
            minute: "2-digit",
          });
          return `I går kl. ${timeString}`;
        } else if (nowObj - datetimeObj < 24 * 60 * 60 * 1000) {
          // Formatting for "last 24 hours"
          console.log(new Date(now).getHours(), datetimeObj.getHours());
          const hoursAgo = new Date(now).getHours() - datetimeObj.getHours();
          const timeString = datetimeObj.toLocaleTimeString("nb-NO", {
            hour: "2-digit",
            minute: "2-digit",
          });
          return `${hoursAgo} timer siden, ${timeString}`;
        } else {
          // Default formatting for dates beyond the last 24 hours
          return datetimeObj
            .toLocaleString("nb-NO", {
              weekday: "short", // short weekday name, e.g., "tirs"
              day: "numeric", // numeric day
              month: "long", // full month name, e.g., "oktober"
              hour: "2-digit", // 2-digit hour
              minute: "2-digit", // 2-digit minute
            })
            .replace(",", " kl.");
        }
      }

      function updateTable(transactions) {
        const tableBody = document
          .getElementById("transactionsTable")
          .getElementsByTagName("tbody")[0];

        // Clear the table body
        tableBody.innerHTML = "";

        // Append each transaction as a new row in the table
        transactions.forEach((transaction) => {
          const row = tableBody.insertRow();
          const fields = ["datetime", "name", "transactionDescription"];

          // datetime
          const cell1 = row.insertCell();
          console.log(transaction.datetime);
          cell1.textContent = formatDatetime(transaction.datetime, Date.now());

          // name
          const cell2 = row.insertCell();
          cell2.textContent = transaction.name;

          // transactionDescription
          const cell3 = row.insertCell();
          cell3.textContent = transaction.transactionDescription;
        });
      }

      async function fetchTransactions() {
        const prom = await fetch("https://batmanhttp.staging.online.ntnu.no/");
        const json = await prom.json();
        console.log(JSON.stringify(json));
        return json;
      }

      function enableAudio() {
        console.log("Audio enabled");
        document.getElementById("enableAudioBtn").hidden = true;
      }

      function playAudio() {
        console.log("Playing audio");
        var audio = document.getElementById("audioPlayer");
        if (audio.ended) {
          audio.currentTime = 0; // Reset to start
        }
        audio.play();
      }
    </script>
    <script>
      let keepAliveInterval = null;

      const SOCKET_URL =
        "wss://y2nndako0h.execute-api.eu-north-1.amazonaws.com/$default/";
      let socket = new WebSocket(SOCKET_URL);
    </script>

    <!-- Socket logic -->
    <script>
      function reconnectSocket() {
        // Ensure the previous socket is cleaned up before creating a new one
        if (socket) {
          socket.removeEventListener("open", handleSocketOpen);
          socket.removeEventListener("message", handleSocketMessage);
          socket.removeEventListener("error", handleSocketError);
          socket.removeEventListener("close", handleSocketClose);
          socket.close();
          socket = null; // Clear the reference to encourage garbage collection
        }

        socket = new WebSocket(SOCKET_URL);
        socket.addEventListener("open", handleSocketOpen);
        socket.addEventListener("message", handleSocketMessage);
        socket.addEventListener("error", handleSocketError);
        socket.addEventListener("close", handleSocketClose);
      }

      function handleSocketOpen(event) {
        console.log("Socket opened", event);
        console.log("Socket opened at " + new Date().toString());
        startKeepAlive();
      }

      function handleSocketMessage(event) {
        console.log("Socket message at " + new Date().toString());
        const transactions = JSON.parse(event.data);
        console.log(transactions);
        updateTable(transactions);
        playAudio();
      }

      function handleSocketError(event) {
        console.log("Socket error", event);
        console.log("Error at " + new Date().toString());
      }

      function handleSocketClose(event) {
        console.log("Socket closed at " + new Date().toString());
        // Reconnect after 10 seconds
        setTimeout(reconnectSocket, 10000);
      }

      function startKeepAlive() {
        if (keepAliveInterval) {
          clearInterval(keepAliveInterval);
        }
        keepAliveInterval = setInterval(() => {
          console.log("Pinging server");
          try {
            socket.send("ping");
          } catch (error) {
            console.log("Error sending ping", error);
            clearInterval(keepAliveInterval);
          }
        }, 3 * 60 * 1000);
      }
    </script>
    <script>
      fetchTransactions().then((data) => {
        updateTable(data.transactions);
        playAudio();
      });
      socket.addEventListener("open", handleSocketOpen);
      socket.addEventListener("message", handleSocketMessage);
      socket.addEventListener("error", handleSocketError);
      socket.addEventListener("close", handleSocketClose);
    </script>
  </body>
</html>
